<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>„Ç≥„Ç®„Ç´„Çø„Éû„É™„É≥È¢®„Éª„Åì„Å®„Å∞„Ç≠„É£„ÉÉ„ÉÅÔºà„Ç≠„É•„ÉºÊäï‰∏ãÁâàÔºâ</title>
<style>
  :root{ --scoreW:200px; --gap:12px; }
  html,body{height:100%;margin:0;background:#0b0e14;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",system-ui}
  canvas{position:fixed;inset:0}
  #ui{
    position:fixed;top:8px;left:12px;right:calc(2*var(--scoreW) + 3*var(--gap));
    display:flex;gap:10px;align-items:center;z-index:10;flex-wrap:wrap
  }
  button{
    background:#1c2435;color:#e7eefc;border:1px solid #32415e;padding:10px 14px;border-radius:12px;
    font-size:16px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)
  }
  button:hover{border-color:#41588a}
  .label{font-size:12px;color:#a9b4c6;margin-left:8px}
  input[type="range"]{width:220px}
  /* „Çπ„Ç≥„Ç¢ */
  #scorePanel{
    position:fixed;top:8px;right:var(--gap);width:var(--scoreW);padding:12px 14px;border-radius:16px;z-index:11;
    background:#121829;border:1px solid #2a3350;color:#cfe1ff;box-shadow:0 8px 24px rgba(0,0,0,.28)
  }
  #scorePanel h2{margin:.2rem 0 .4rem;font-size:14px;color:#9fb7ff;font-weight:600;letter-spacing:.02em}
  #scoreVal{font-size:44px;line-height:1;font-weight:800}
  #speedVal{display:inline-block;min-width:3ch;text-align:right}
  /* „Ç≠„É•„ÉºÔºà„Çπ„Ç≥„Ç¢Â∑¶Ôºâ */
  #queuePanel{
    position:fixed;top:8px;right:calc(var(--gap) + var(--scoreW) + var(--gap));
    width:var(--scoreW);padding:12px 14px;border-radius:16px;z-index:11;
    background:#0f1528;border:1px solid #253057;color:#d8e3ff;box-shadow:0 8px 24px rgba(0,0,0,.28)
  }
  #queuePanel h2{margin:.2rem 0 .4rem;font-size:14px;color:#a9c2ff;font-weight:600;letter-spacing:.02em}
  #queueList{max-height:50vh;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-right:2px}
  .qItem{
    background:#162042;border:1px solid #2b3b6c;border-radius:12px;padding:6px 10px;
    font-weight:700;letter-spacing:.02em;display:flex;align-items:center;justify-content:center
  }
  .qItem span{font-family:"Zen Maru Gothic","Noto Sans JP",sans-serif;font-size:22px;line-height:1}
  /* LED */
  #leds{position:fixed;top:54px;left:12px;right:calc(2*var(--scoreW) + 3*var(--gap));display:flex;gap:10px;z-index:9;font-size:12px;color:#a9b4c6}
  .led{width:10px;height:10px;border-radius:50%;background:#525b6e;display:inline-block;margin-right:6px;vertical-align:middle}
  .on{background:#2ecc71;box-shadow:0 0 0 3px rgba(46,204,113,.18)}
  @media (max-width:920px){
    #ui{right:12px}
    #queuePanel{top:64px;right:12px;width:auto}
    #scorePanel{top:118px;right:12px;width:auto}
    #leds{right:12px}
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">
<!-- „Åã„Å™Â§âÊèõÔºàÊº¢Â≠ó‚Üí„Å≤„Çâ„Åå„Å™Ôºâ -->
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dist/kuromoji.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuroshiro@1.2.0/dist/kuroshiro.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js"></script>
</head>
<body>
  <canvas id="cv"></canvas>

  <div id="ui">
    <button id="startBtn">üéôÔ∏è „ÅØ„Åò„ÇÅ„Çã</button>
    <button id="stopBtn">‚èπ „Å®„ÇÅ„Çã</button>

    <span class="label">ËêΩ‰∏ã„Çπ„Éî„Éº„Éâ</span>
    <input id="speed" type="range" min="0.5" max="2.0" step="0.1" value="1.0" />
    <span class="label"><span id="speedVal">1.0</span>√ó</span>
  </div>

  <div id="leds">
    <span><span id="micLed" class="led"></span>„Éû„Ç§„ÇØ</span>
    <span><span id="asrLed" class="led"></span>Èü≥Â£∞Ë™çË≠ò</span>
  </div>

  <aside id="queuePanel">
    <h2>„Å§„Åé„Å´ „Åä„Å°„Çã „Åì„Å®„Å∞</h2>
    <div id="queueList"></div>
  </aside>

  <aside id="scorePanel">
    <h2>„Çπ„Ç≥„Ç¢</h2>
    <div id="scoreVal">0</div>
  </aside>

<script>
(() => {
  // ===== Canvas =====
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  function measureTextBox(text, size){
    ctx.save();
    ctx.font = `bold ${size}px "Zen Maru Gothic","YuKyokasho","Noto Sans JP",sans-serif`;
    const prev = ctx.textBaseline;
    ctx.textBaseline = 'alphabetic';
    const m = ctx.measureText(text);
    const ascent  = (m.actualBoundingBoxAscent  ?? size*0.82);
    const descent = (m.actualBoundingBoxDescent ?? size*0.18);
    const width   = m.width;
    ctx.textBaseline = prev;
    ctx.restore();
    return { w: width, h: ascent + descent, ascent, descent };
  }

  const words = []; // ÁîªÈù¢ÂÜÖ„ÅßÂãï„Åè„Åì„Å®„Å∞

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    cv.width = Math.floor(innerWidth * dpr);
    cv.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    for(const o of words){
      const tb = measureTextBox(o.text, o.size);
      o.w = tb.w; o.h = tb.h; o.ascent = tb.ascent; o.descent = tb.descent;
      const halfW = o.w/2, halfH = o.h/2;
      if(o.x < halfW + 1) o.x = halfW + 1;
      if(o.x > innerWidth - halfW - 1) o.x = innerWidth - halfW - 1;
      const bottomY = innerHeight - 1;
      if(o.y + halfH > bottomY) o.y = bottomY - halfH;
    }
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // ===== UI refs =====
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const micLed   = document.getElementById('micLed');
  const asrLed   = document.getElementById('asrLed');
  const speed    = document.getElementById('speed');
  const speedVal = document.getElementById('speedVal');
  const scoreEl  = document.getElementById('scoreVal');
  const queueListEl = document.getElementById('queueList');

  let speedFactor = parseFloat(speed.value);
  speed.addEventListener('input', () => {
    speedFactor = parseFloat(speed.value);
    speedVal.textContent = speedFactor.toFixed(1);
  });

  // ===== Audio (volume only) =====
  let mediaStream=null, audioCtx=null, analyser=null, floatBuf=null, rafVol=null, lastVol=0.15;
  function rms(buf){ let s=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; s+=v*v; } return Math.sqrt(s/buf.length); }
  function volumeLoop(){
    if(!analyser) return;
    analyser.getFloatTimeDomainData(floatBuf);
    let v = Math.min(0.5, rms(floatBuf));
    const norm = Math.pow(v/0.5, 0.6);
    lastVol = 0.1 + 0.9*norm;
    rafVol = requestAnimationFrame(volumeLoop);
  }
  async function startMic(){
    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:false }, video:false
    });
    micLed.classList.add('on');
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(mediaStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    floatBuf = new Float32Array(analyser.fftSize);
    src.connect(analyser);
    volumeLoop();
  }
  function stopMic(){
    if(rafVol) cancelAnimationFrame(rafVol), rafVol=null;
    if(audioCtx) { audioCtx.close(); audioCtx=null; }
    if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
    analyser=null; floatBuf=null; micLed.classList.remove('on');
  }

  // ===== „Åã„Å™ÂåñÔºà„Åì„Å®„Å∞ÔºùÂ°äÔºâ =====
  let kuroshiro = null, kuroReady = false;
  (async () => {
    try{
      kuroshiro = new Kuroshiro();
      await kuroshiro.init(new KuromojiAnalyzer({ dictPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/' }));
      kuroReady = true;
    }catch(e){ console.warn('Kuroshiro init failed, fallback to „Ç´„Çø‚Üí„Å≤„Çâ„ÅÆ„Åø„ÄÇ', e); }
  })();
  function kataToHira(str){
    return str.replace(/[\u30A1-\u30FA\u30FC]/g, ch => ch==='„Éº' ? '„Éº' : String.fromCharCode(ch.charCodeAt(0) - 0x60));
  }
  function stripNonKana(str){
    return str.replace(/[^\u3040-\u309F\u30A0-\u30FF\u30FC\s]+/g, '');
  }
  async function toHiraganaWords(str){
    if(kuroReady){
      try{
        const hira = await kuroshiro.convert(str, { to:'hiragana', mode:'spaced' });
        return hira.trim().split(/\s+/).filter(Boolean);
      }catch(e){ console.warn('kuroshiro.convert error, fallback.', e); }
    }
    const hira = kataToHira(stripNonKana(str));
    return hira.trim().split(/\s+/).filter(Boolean);
  }

  // ===== Speech RecognitionÔºàÂçò‰∏ÄÂÆöÁæ©Ôºâ =====
  let recognizer=null, recognizing=false;
  function setupASR(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const rec = new SR();
    rec.lang = 'ja-JP';
    rec.interimResults = true;
    rec.continuous = true;
    rec.maxAlternatives = 1;

    rec.onstart = ()=>{ asrLed.classList.add('on'); recognizing=true; };
    rec.onend   = ()=>{ asrLed.classList.remove('on'); recognizing=false; };
    rec.onerror = (e)=>{ console.warn('ASR error', e); };

    rec.onresult = (e)=>{
      let finalChunk = '';
      for(let i=e.resultIndex;i<e.results.length;i++){
        if(e.results[i].isFinal) finalChunk += e.results[i][0].transcript;
      }
      if(!finalChunk) return;
      (async () => {
        const wordsArr = await toHiraganaWords(finalChunk);
        enqueueWords(wordsArr);        // ‚Üê „Åì„Åì„Åß‚ÄúË°®Á§∫„Ç≠„É•„Éº‚Äù„Å∏
      })();
    };
    return rec;
  }
  function setupASROnce(){ if(recognizer) return recognizer; recognizer = setupASR(); return recognizer; }

  // ===== „Åì„Å®„Å∞ËêΩ‰∏ãÔºàÁîªÈù¢ÂÜÖ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ =====
  const BASE_GRAVITY = 520, AIR_DRAG = 0.0012, WIND_JITTER = 16, MAX_WORDS = 1000;

  function rand(min,max){ return min + Math.random()*(max-min); }
  function randomColor(){
    const h = Math.floor(rand(0,360));
    const s = Math.floor(rand(60,95));
    const l = Math.floor(rand(55,80));
    return `hsl(${h} ${s}% ${l}%)`;
  }
  function newSizeFromVolume(){ const min=22, max=120; return min + (max - min) * lastVol; }

  function spawnWord(text){
    const size = newSizeFromVolume();
    const tb = measureTextBox(text, size);
    const halfW = tb.w / 2, halfH = tb.h / 2;
    const x = rand(halfW + 1, innerWidth - halfW - 1);
    const y = -halfH - rand(2, 24);
    const vx = rand(-180, 180) * speedFactor;
    const vy = rand(10, 60) * speedFactor;
    const color = randomColor();
    words.push({ text, x, y, vx, vy, size, w:tb.w, h:tb.h, ascent:tb.ascent, descent:tb.descent, color, scored:false });
    if(words.length > MAX_WORDS) words.shift();
  }

  function step(dt){
    const g = BASE_GRAVITY * speedFactor;
    for(const o of words){
      o.vy += g * dt;
      o.vx += (Math.random()-0.5) * WIND_JITTER * dt;
      o.vx -= o.vx * AIR_DRAG;
      o.vy -= o.vy * AIR_DRAG;
      o.x += o.vx * dt;
      o.y += o.vy * dt;

      const halfW = o.w/2, halfH = o.h/2;
      if(o.x < halfW + 1){ o.x = halfW + 1; o.vx = Math.abs(o.vx)*0.65; }
      if(o.x > innerWidth - halfW - 1){ o.x = innerWidth - halfW - 1; o.vx = -Math.abs(o.vx)*0.65; }

      const bottomY = innerHeight - 1;
      if(o.y + halfH > bottomY){
        o.y = bottomY - halfH;
        o.vy = -Math.abs(o.vy) * 0.45;
        o.vx *= 0.85;
        if(Math.abs(o.vy) < 30) o.vy = -120 * speedFactor;
      }
      if(o.y - halfH < -2){
        o.y = halfH;
        o.vy = Math.abs(o.vy);
      }
    }
  }

  function draw(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    for(const o of words){
      ctx.save();
      ctx.translate(o.x, o.y);
      ctx.font = `bold ${o.size}px "Zen Maru Gothic","YuKyokasho","Noto Sans JP",sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = o.color;
      ctx.shadowColor = 'rgba(0,0,0,.45)';
      ctx.shadowBlur = 12;
      ctx.fillText(o.text, 0, 0);
      ctx.restore();
    }
  }

  // ===== „Çπ„Ç≥„Ç¢ÔºàËß¶„Çå„Åü/„Çø„ÉÉ„Éó„Åß+1Ôºâ =====
  let score = 0;
  function addScoreOnce(o){
    if(o.scored) return;
    o.scored = true;
    score += 1;
    scoreEl.textContent = score;
    const old = o.size;
    o.size = old * 1.25;
    setTimeout(()=>{
      o.size = old;
      const tb = measureTextBox(o.text, o.size);
      o.w = tb.w; o.h = tb.h; o.ascent = tb.ascent; o.descent = tb.descent;
    }, 120);
  }
  function hitTest(px, py, o){
    const halfW = o.w/2, halfH = o.h/2;
    return (px >= o.x - halfW && px <= o.x + halfW && py >= o.y - halfH && py <= o.y + halfH);
  }
  function handlePointer(px, py){
    for(let i=words.length-1;i>=0;i--){
      const o = words[i];
      if(hitTest(px, py, o)){ addScoreOnce(o); break; }
    }
  }
  cv.addEventListener('pointerdown', e=>{ handlePointer(e.clientX, e.clientY); });
  cv.addEventListener('pointermove', e=>{
    if(e.pointerType === 'mouse'){ handlePointer(e.clientX, e.clientY); }
  }, {passive:true});

  // ===== Ë°®Á§∫„Ç≠„É•„ÉºÔºö„Çπ„Ç≥„Ç¢Â∑¶„Å´Á∏¶Ë°®Á§∫ ‚Üí 1Áßí„Åî„Å®„Å´ÂÖàÈ†≠„ÇíËêΩ„Å®„Åô =====
  const queueWords = [];           // ÂæÖ„Å°Ë°åÂàóÔºàÊñáÂ≠óÂàóÔºâ
  let queueTimer = null;           // 1Áßí„Çø„Ç§„Éû„Éº
  function renderQueue(){
    queueListEl.innerHTML = '';
    for(const w of queueWords){
      const div = document.createElement('div');
      div.className = 'qItem';
      const s = document.createElement('span');
      s.textContent = w;
      div.appendChild(s);
      queueListEl.appendChild(div);
    }
  }
  function ensureQueueTimer(){
    if(queueTimer) return;
    queueTimer = setInterval(() => {
      if(queueWords.length === 0) return;
      const next = queueWords.shift(); // ‚ë†‰∏ÄÁï™‰∏ä„ÇíÂèñ„ÇäÂá∫„Åô
      renderQueue();                   // ‚ë°Ë°®Á§∫„Åã„ÇâÊ∂à„Åà„Çã
      spawnWord(next);                 // ‚ë¢1Áßí„Åî„Å®„Å´ËêΩ‰∏ã„Åï„Åõ„Çã
    }, 1000);
  }
  function enqueueWords(arr){
    for(const w of arr){
      if(!w || !w.trim()) continue;
      queueWords.push(w.trim());
    }
    renderQueue();     // ËøΩÂä†„Åó„Åü„ÇâÂç≥„ÄÅÂè≥„ÅÆ„É™„Çπ„Éà„Å´Ë°®Á§∫
    ensureQueueTimer(); // „Çø„Ç§„Éû„Éº„ÇíËµ∑ÂãïÔºàÊó¢„Å´Âãï„ÅÑ„Å¶„ÅÑ„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºâ
  }
  function clearQueueTimer(){
    if(queueTimer){ clearInterval(queueTimer); queueTimer=null; }
  }

  // ===== „É´„Éº„Éó =====
  let raf=null, lastT=performance.now();
  function loop(){
    const now = performance.now();
    let dt = (now - lastT)/1000; lastT = now;
    const sub = Math.min(4, Math.max(1, Math.ceil(dt/0.01)));
    const h = dt / sub;
    for(let i=0;i<sub;i++) step(h);
    draw();
    raf = requestAnimationFrame(loop);
  }

  // ===== Start/Stop =====
  let mediaStarted=false;
  async function startAll(){
    try{ await startMic(); mediaStarted=true; }catch(e){ alert('„Éû„Ç§„ÇØ„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n'+e); return; }
    setupASROnce();
    if(recognizer && !recognizing){ try{ recognizer.start(); }catch(_){} }
    if(!raf) { lastT = performance.now(); loop(); }
    ensureQueueTimer();
  }
  function stopAll(){
    if(recognizer && recognizing){ try{ recognizer.stop(); }catch(_){} }
    recognizing=false; asrLed.classList.remove('on');
    stopMic(); mediaStarted=false;
    if(raf) cancelAnimationFrame(raf), raf=null;
    clearQueueTimer();
  }
  startBtn.addEventListener('click', startAll);
  stopBtn.addEventListener('click', stopAll);
  window.addEventListener('pagehide', stopAll);

  // „Éï„Ç©„É≥„Éà„Ç¶„Ç©„Éº„É†„Ç¢„ÉÉ„Éó
  ctx.font = 'bold 80px "Zen Maru Gothic","Noto Sans JP",sans-serif';
  ctx.fillStyle = '#0b0e14';
  ctx.fillText('„ÅÇ', -9999, -9999);
})();
</script>
</body>
</html>
